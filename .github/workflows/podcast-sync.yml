name: Sync Podcast to Podbean

on:
    # # Run on schedule (daily at 6 AM UTC)
    # schedule:
    #   - cron: '0 6 * * *'

    # Allow manual trigger
    workflow_dispatch:
        inputs:
            dry_run:
                description: 'Dry run (show what would be synced without uploading)'
                required: false
                default: 'false'
                type: choice
                options:
                    - 'true'
                    - 'false'
            upload_s3:
                description: 'Upload handbook audio to S3'
                required: false
                default: 'true'
                type: choice
                options:
                    - 'true'
                    - 'false'
            limit:
                description: 'Limit number of handbook files to process (empty = all allowed files)'
                required: false
                type: string
            status:
                description: 'Status for new episodes'
                required: false
                default: 'draft'
                type: choice
                options:
                    - draft
                    - publish

jobs:
    sync:
        name: Sync S3 to Podbean
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v4

            - name: Set up Python
              run: uv python install 3.12

            - name: Install dependencies
              run: |
                  cd scripts/hogfm
                  uv sync

            - name: Generate handbook audio
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.PODCAST_AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.PODCAST_AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: ${{ secrets.PODCAST_AWS_REGION || 'us-east-1' }}
                  ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
                  ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
                  S3_BUCKET: ${{ secrets.S3_BUCKET }}
              run: |
                  cd scripts/hogfm

                  # Build arguments based on inputs
                  ARGS="--allowed-only"

                  if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
                    ARGS="$ARGS --dry-run"
                  fi

                  if [ "${{ github.event.inputs.upload_s3 }}" != "false" ]; then
                    ARGS="$ARGS --upload-s3"
                  fi

                  if [ -n "${{ github.event.inputs.limit }}" ]; then
                    ARGS="$ARGS --limit ${{ github.event.inputs.limit }}"
                  fi

                  uv run handbook-audio $ARGS

            - name: Sync podcasts to Podbean
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.PODCAST_AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.PODCAST_AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: ${{ secrets.PODCAST_AWS_REGION || 'us-east-1' }}
                  PODBEAN_CLIENT_ID: ${{ secrets.PODBEAN_CLIENT_ID }}
                  PODBEAN_CLIENT_SECRET: ${{ secrets.PODBEAN_CLIENT_SECRET }}
              run: |
                  cd scripts/hogfm

                  # Determine arguments based on inputs
                  ARGS=""

                  if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
                    ARGS="$ARGS --dry-run"
                  fi

                  if [ -n "${{ github.event.inputs.status }}" ]; then
                    ARGS="$ARGS --status ${{ github.event.inputs.status }}"
                  else
                    ARGS="$ARGS --status draft"
                  fi

                  uv run python sync_s3_to_podbean.py $ARGS
