---
title: Developing locally
sidebar: Docs
showTitle: true
---

<blockquote class="warning-note">
    ⚠️ Do not use <code>release-*</code> patterns in your branches unless pushing a release as these branches have
    special handling related to releases.
</blockquote>

## What does it take?

To run PostHog, you must run the following services:

- PostHog's Django Backend
- PostHog's Celery Worker
- PostHog's NodeJS Plugin Server
- PostHog's NodeJS Frontend
- PostgreSQL
- Redis
- ClickHouse
- Kafka
- Zookeeper

The guide below explains how to get them all running.

We officially support only one way of running PostHog, where all services (Postgres, Redis, ClickHouse, Kafka, Zookeeper) run via Docker, with PostHog's apps running natively on your system.
For a while, we used to support running the PostHog apps themselves in Docker, but recently deprecated this approach because 1) that made everything really really slow, 2) you need to install nodejs and python locally anyway if you want to commit any code due to our pre-commit hooks (black & prettier). Thus to simplify instructions, we consolidated on the steps below.

The instructions below assume you're running MacOS. For Linux, adjust the steps as needed (e.g. use `apt` instead of `brew`).

In case some steps here have fallen out of date, please tell us about it by [submitting a patch](https://github.com/PostHog/posthog.com/tree/master/contents/docs/contribute/developing-locally.mdx).

## Mac OS prerequisites

1. Install xcode developer tools if you haven't already: `xcode-select --install`.

2. Install Homebrew by following the [instructions here](https://brew.sh/).

<blockquote class="warning-note">
    Note: After installation, make sure to follow the instructions printed in your terminal to add homebrew to your path. Same for <code>nvm</code> and <code>pyenv</code> below.
</blockquote>

3. Install [Docker Desktop](https://www.docker.com/products/docker-desktop) and give it **at least 4 GB of RAM** (6GB if you can afford it) and 8 CPU cores.

4. Add the following lines to `/etc/hosts`:

```
127.0.0.1 kafka clickhouse
```

Somehow ClickHouse and Kafka won't be able to talk to each other without these mapped hosts.

5. Clone the [PostHog repository](https://github.com/posthog/posthog) locally. All future commands assume you're inside the `posthog/` folder.

```bash
git clone https://github.com/PostHog/posthog
cd posthog
```

## Run PostHog natively, run the services in docker.

### Step 1. Backend services

In this step we will install Postgres, Redis, ClickHouse, Kafka and Zookeeper via Docker.

First, run the services via Docker:

```bash
# Apple Silicon (arm64)
docker-compose -f ee/docker-compose.ch.arm64.yml pull zookeeper kafka clickhouse db redis
docker-compose -f ee/docker-compose.ch.arm64.yml up zookeeper kafka clickhouse db redis

# x86 systems (amd64)
docker-compose -f ee/docker-compose.ch.yml pull zookeeper kafka clickhouse db redis
docker-compose -f ee/docker-compose.ch.yml up zookeeper kafka clickhouse db redis
```

> **Friendly tip 1:** If you see `Error while fetching server API version: 500 Server Error for http+docker://localhost/version:`, likely Docker Engine isn't running.

> **Friendly tip 2:** If you see "Exit Code 137" anywhere, it means you need to add more RAM to Docker.

> **Friendly tip 3:** You might need `sudo`, see more [manage docker as non-root](https://docs.docker.com/engine/install/linux-postinstall).


Second, verify via `docker ps` and `docker logs` (or via the Docker Desktop Dashboard) that all these services are up and running. They should display something like this in their logs:

```
# docker ps
CONTAINER ID   IMAGE                                  COMMAND                  CREATED        STATUS        PORTS                                                                                            NAMES
b0f72510b818   posthog/clickhouse:v21.9.2.17-stable   "/entrypoint.sh"         26 hours ago   Up 21 hours   0.0.0.0:8123->8123/tcp, 0.0.0.0:9000->9000/tcp, 0.0.0.0:9009->9009/tcp, 0.0.0.0:9440->9440/tcp   ee_clickhouse_1
12d146b93d69   wurstmeister/kafka                     "start-kafka.sh"         26 hours ago   Up 21 hours   0.0.0.0:9092->9092/tcp                                                                           ee_kafka_1
432afd46fc93   postgres:12-alpine                     "docker-entrypoint.s…"   26 hours ago   Up 21 hours   0.0.0.0:5432->5432/tcp                                                                           ee_db_1
cdbf065ffa3f   zookeeper                              "/docker-entrypoint.…"   26 hours ago   Up 21 hours   2181/tcp, 2888/tcp, 3888/tcp, 8080/tcp                                                           ee_zookeeper_1
ff77dcf7facd   redis:alpine                           "docker-entrypoint.s…"   26 hours ago   Up 21 hours   0.0.0.0:6379->6379/tcp                                                                           ee_redis_1

# docker logs ee_db_1 -n 1
2021-12-06 13:47:08.325 UTC [1] LOG:  database system is ready to accept connections

# docker logs ee_redis_1 -n 1
1:M 06 Dec 2021 13:47:08.435 * Ready to accept connections

# docker logs ee_clickhouse_1 -n 1
Saved preprocessed configuration to '/var/lib/clickhouse/preprocessed_configs/users.xml'.

# docker logs ee_kafka_1
[2021-12-06 13:47:23,814] INFO [KafkaServer id=1001] started (kafka.server.KafkaServer)

# docker logs ee_zookeeper_1
# Because ClickHouse and Kafka connect to Zookeeper, there will be a lot of noise here. That's good.
```

> **Friendly tip:** Kafka is currently the only x86 container used, and might segfault randomly when running on Apple Silicon. Restart it when that happens.

Finally, install Postgres locally anyway.

Even if we plan to run Postgres inside Docker, we need a local copy of Postgres (min v11, recommended v14) for its CLI tools and development libraries/headers. These are required by `pip` to install `psycopg2`.

On Mac OS you would run:

```bash
brew install postgresql
```

This installs both the Postgres server and its tools. DO NOT start the server after running this.

On Linux you often have separate packages: `postgres` for the tools, `postgres-server` for the server, and `libpostgres-dev` for the `psycopg2` dependencies. Consult your distro's list for an up to date list of pacakages.


### Step 2. NodeJS Frontend

1. Install nvm by following the [instructions here](https://github.com/nvm-sh/nvm)

2. Install the latest minor release of NodeJS 14 with `nvm install 14`.

3. Install yarn version 1.22 with `npm install -g yarn@1`

4. Install npm packages by running `yarn`

5. Run `yarn start`, which runs in parallel 1) our [esbuild](https://esbuild.github.io/)-powered dev server, 2) [kea-typegen](https://github.com/keajs/kea-typegen), which generates `logicType.ts` files for each `logic.ts` in the codebase.

6. The first time you run typegen, it may get stuck in a loop. If so, cancel the process (`ctrl+c`), discard all changes in the working directory (`git reset --hard`), and run `yarn start` again. You may need to discard all changes once more when the second round of type generation completes.

### Step 3. NodeJS Plugin Server

1. Assuming NodeJS is installed, run `cd plugin-server && yarn` to install all required packages.

### Step 4. Python Backend

1. Install pyenv by following the [instructions here](https://github.com/pyenv/pyenv).

2. Install the latest path release of Python 3.9 with `pyenv install 3.9` (and then selecting the precise version from the list presented). For example:

```
pyenv install 3.9 # gives a list of versions to install
pyenv install 3.9.9
pyenv global 3.9.9
```

3. Create the virtual environment in current directory called 'env':

```bash
python3 -m venv env
```

4. Activate the virtual environment:

```bash
# for bash/zsh/etc
source env/bin/activate

# if you're using the fish shell
source env/bin/activate.fish
```

5. Install requirements with pip

If you're on Apple Silicon, the first time your run `pip install` you must pass it custom openssl headers:

```bash
brew install openssl
CFLAGS="-I /opt/homebrew/opt/openssl/include" LDFLAGS="-L /opt/homebrew/opt/openssl/lib" GRPC_PYTHON_BUILD_SYSTEM_OPENSSL=1 GRPC_PYTHON_BUILD_SYSTEM_ZLIB=1 pip install -r requirements.txt
```

These will be used when installing `grpcio` and `psycopg2`. After doing this once, and assuming nothing changed with these two packages, next time simply run:

```bash
pip install -r requirements.txt
```

6. SAML support.

If you want to fully test all our features, you'll need to install a few dependencies for SAML to run properly. If you're on macOS, run the command below, otherwise check out the official [xmlsec repo](https://github.com/mehcode/python-xmlsec) for more details.

```
brew install libxml2 libxmlsec1 pkg-config
pip install python3-saml==1.12.0
```

7. Install dev requirements:

```bash
pip install -r requirements-dev.txt
```

### Step 5. Run database migrations

```bash
export DEBUG=1
export PRIMARY_DB=clickhouse
export SKIP_SERVICE_VERSION_REQUIREMENTS=1
export DATABASE_URL=postgres://posthog:posthog@localhost:5432/posthog

python manage.py migrate
python manage.py migrate_clickhouse
```

> **Friendly tip:** The error `fe_sendauth: no password supplied` connecting to Postgres happens when the database is set up with a password and the user:pass isn't specified in `DATABASE_URL`. Try `export DATABASE_URL=postgres://posthog:posthog@localhost:5432/posthog`.

> **Another friendly tip:** You may run into `psycopg2` errors while migrating on a Apple Silicon machine. Try out the steps in this [comment](https://github.com/psycopg/psycopg2/issues/1216#issuecomment-820556849) to resolve this.

### Step 6. Run PostHog

Start the backend, worker, and frontend simultaneously with:

```bash
export KAFKA_HOSTS=kafka:9092
./bin/start
```

Now open [http://localhost:8000](http://localhost:8000) to see the app.

> **Note:** The first time you run this command you might get an error that says "layout.html is not defined". Make sure you wait until the frontend is finished compiling and try again.

To see some data on the frontend, you should go to the `http://localhost:8000/demo` and play around with it, so you can see some data on dashboard.

<br />
<hr />

## Running PostHog

PostHog consists of the following apps:

- PostHog's Django Backend
- PostHog's Celery Worker
- PostHog's NodeJS Plugin Server
- PostHog's NodeJS Frontend

You can run each of them separately (a common scenario when debugging services separately), or all at once.

### Running backend, worker, plugin server and frontend all together

This script runs the below three scripts concurrently, and automatically sets `DEBUG=1`.

Run `KAFKA_HOSTS=kafka:9092 ./bin/start`

### Running backend separately (Django)

Run `DEBUG=1 ./bin/start-backend`

### Running background worker (Celery) and Plugin Server (NodeJS) separately

Run `DEBUG=1 KAFKA_HOSTS=kafka:9092 ./bin/start-worker`

### Running frontend separately (React)

Run `yarn start`

### Running backend tests

Run `./bin/tests`

To see debug logs (includes e.g. ClickHouse queries), run `./bin/tests --log-cli-level=DEBUG`

### Running end-to-end Cypress tests

Run `./bin/e2e-test-runner`

### Debugging the backend in PyCharm

With [PyCharm's](https://posthog.com/handbook/engineering/beginners-guide/developer-workflow#alternative-pycharm) built in support for Django, it's fairly easy to setup debugging in the backend. This is especially useful when you want to trace and debug a network request made from the client all the way back to the server. You can set breakpoints and step through code to see exactly what the backend is doing with your request.

1. Setup Django configuration as per JetBrain's [docs](https://blog.jetbrains.com/pycharm/2017/08/develop-django-under-the-debugger/).
2. Click Edit Configuration to edit the Django Server configuration you just created.
3. Point PyCharm to the project root (`posthog/`) and settings (`posthog/posthog/settings.py`) file.
4. Add these environment variables

```
DEBUG=1;
KAFKA_HOSTS=kafka:9092;
DATABASE_URL=postgres://posthog:posthog@localhost:5432/posthog
```

### Let's spin it up!

1. Run `./bin/start-frontend`
2. Run `./bin/start-worker`
3. Set some breakpoints
4. In the top toolbar, select the config you just created and click the green bug icon. This runs `python manage.py runserver` with extra parameters that enable debugging.

## Testing ingestion and feature flags

> **Note:** When developing locally and setting environment variable `DEBUG=1`, the local server is treated as what would be "PostHog Cloud". This means that all analytics that are captured from the usage of PostHog are sent to this same local instance (can be quite useful to generate test data too). In addition, feature flags are considered based on the local instance.

Run `python manage.py sync_feature_flags` to create all used flags locally.

Add feature flags to your [local instance](http://localhost:8000/feature_flags/new) to use them while developing locally. For example, let's say you want to test the using the `my-feature-flag` flag locally - you would create a new flag with the name `my-feature-flag` and release that flag to the user account used for testing. Learn more about using feature flags in the [Feature Flags user guide](//posthog.com/docs/user-guides/feature-flags).
