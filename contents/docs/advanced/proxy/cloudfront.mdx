---
title: AWS CloudFront reverse proxy
sidebar: Docs
showTitle: true
platformImageUrl: https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/Cloud_Front_f25116d5fb.png
---

import ProxyCallout from "../_snippets/proxy-callout.mdx"
import { Steps, Step } from 'components/Docs/Steps'

<ProxyCallout />

This guide shows you how to configure [AWS CloudFront](https://docs.aws.amazon.com/cloudfront/) as a reverse proxy for PostHog.

CloudFront requires custom cache and origin request policies. Without these, it won't forward the headers, cookies, and query parameters PostHog needs.

<CalloutBox icon="IconWarning" title="Watch your size limits" type="caution">

Some AWS services have size limits that can cause problems when used with a reverse proxy. For example, AWS WAF defaults to 8KB. PostHog events can be up to 1MB and session recordings can be up to 64MB per message, so you may need to adjust your limits.

</CalloutBox>

## Configuration overview

You'll need to create two origins in CloudFront:
- **Main origin** for event ingestion: `us.i.posthog.com` or `eu.i.posthog.com`
- **Assets origin** for static files: `us-assets.i.posthog.com` or `eu-assets.i.posthog.com`

Then create custom cache and origin request policies to handle PostHog's requirements.

## Setup

<Steps>

<Step title="Create a CloudFront distribution">

Follow AWS's guide to [create a CloudFront distribution](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-creating-console.html).

Use these PostHog settings:

**Origin settings:**
- **Origin domain:** `us.i.posthog.com` or `eu.i.posthog.com`
- **Protocol:** HTTPS only

**Default cache behavior:**
- **Allowed HTTP methods:** `GET`, `HEAD`, `OPTIONS`, `PUT`, `POST`, `PATCH`, `DELETE`
- **Cache HTTP methods:** Check `OPTIONS`

</Step>

<Step title="Create a cache policy">

Follow AWS's guide to [create a cache policy](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/controlling-the-cache-key.html#cache-key-create-cache-policy).

Use these settings:

- **Name:** `origin-cors`
- **Headers:** Include `Origin` and `Authorization`
- **Query strings:** All

</Step>

<Step title="Apply policies to your distribution">

Edit your distribution and apply these policies:

- **Cache policy:** Your new `origin-cors` policy
- **Origin request policy:** `CORS-CustomOrigin`
- **AWS WAF:** Leave disabled

</Step>

<Step title="Add the assets origin">

Add a second origin to your distribution for PostHog's static assets:

- **Origin domain:** `us-assets.i.posthog.com` or `eu-assets.i.posthog.com`

</Step>

<Step title="Create an origin request policy">

Follow AWS's guide to [create an origin request policy](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/controlling-origin-requests.html#origin-request-create-origin-request-policy).

Use these settings:

- **Name:** `origin-request-policy`
- **Headers:** Include `Origin`
- **Query strings:** All

</Step>

<Step title="Create a behavior for static assets">

Add a new behavior to your distribution with these settings:

- **Path pattern:** `/static/*`
- **Origin:** Your assets origin `us-assets.i.posthog.com` or `eu-assets.i.posthog.com`
- **Cache policy:** `origin-cors`
- **Origin request policy:** Your new `origin-request-policy`
- **Response headers policy:** `CORS-with-preflight-and-SecurityHeadersPolicy`

If you get CORS errors, create a custom Response Headers Policy with `Access-Control-Allow-Headers` set to all headers. See [AWS's CORS troubleshooting guide](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/header-caching.html#header-caching-web-cors) for details.

</Step>

</Steps>

## Use your CloudFront distribution

Once created, copy the distribution domain name and set it as your API host in PostHog:

```js
posthog.init('<ph_project_api_key>', {
  api_host: 'https://<distribution_domain_name>.cloudfront.net',
  ui_host: 'https://us.posthog.com' // Use https://eu.posthog.com for EU region
})
```

Replace `<distribution_domain_name>` with your actual CloudFront domain.

