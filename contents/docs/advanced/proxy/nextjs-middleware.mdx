---
title: Use Next.js middleware as a reverse proxy
sidebar: Docs
showTitle: true
---

import ProxyCallout from "../_snippets/proxy-callout.mdx"
import { Steps, Step } from 'components/Docs/Steps'

<ProxyCallout />

This guide shows you how to use [Next.js middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware) as a reverse proxy for PostHog.

## When to use this method

There are two ways to proxy PostHog with Next.js: rewrites and middleware. Both work with the app router and pages router.

**Use [rewrites](/docs/advanced/proxy/nextjs) when:**

- You want the simplest setup
- You're using Vercel or self-hosting Next.js
- You don't need custom logic in the proxy

**Use middleware when:**

- Rewrites aren't working on your host, returning `503` or `400` errors
- You need to modify headers or add custom logic
- You want more control over the proxy behavior

For most cases, [rewrites](/docs/advanced/proxy/nextjs) are simpler. Try that method first.

## Setup

<Steps>

<Step title="Create a middleware file">

Create a file named `middleware.js` in your base directory, at the same level as the `app` folder:

```js
import { NextResponse } from 'next/server'
 
export function middleware(request) {
  let url = request.nextUrl.clone()
  const hostname = url.pathname.startsWith("/<ph_proxy_path>/static/") 
    ? 'us-assets.i.posthog.com' 
    : 'us.i.posthog.com'
  
  const requestHeaders = new Headers(request.headers)
  requestHeaders.set('host', hostname)

  url.protocol = 'https'
  url.hostname = hostname
  url.port = 443
  url.pathname = url.pathname.replace(/^\/<ph_proxy_path>/, '');

  return NextResponse.rewrite(url, {
    headers: requestHeaders,
  })
}
 
export const config = {
  matcher: '/<ph_proxy_path>/:path*',
}
```

Replace `<ph_proxy_path>` with your chosen path (like `ph`). Replace `us` with `eu` for EU region.

See [Next.js middleware documentation](https://nextjs.org/docs/app/building-your-application/routing/middleware) for more details.

</Step>

<Step title="Add skipTrailingSlashRedirect to next.config.js">

Add this option to your `next.config.js` file:

```js
// next.config.js
const nextConfig = {
  // This is required to support PostHog trailing slash API requests
  skipTrailingSlashRedirect: true, 
}

module.exports = nextConfig
```

</Step>

<Step title="Update your PostHog SDK">

Use your proxy path as the API host:

```js
posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY, {
  api_host: "/<ph_proxy_path>",
  ui_host: "https://us.posthog.com" // Use https://eu.posthog.com for EU region
})
```

Replace `<ph_proxy_path>` with your chosen path.

</Step>

<Step title="Deploy your changes">

Deploy your Next.js app. The middleware will be active once deployed.

</Step>

</Steps>

## Troubleshooting

For common issues like region mismatches, `ui_host` configuration, and 405 errors, see [best practices and common issues](/docs/advanced/proxy#best-practices-and-common-issues).

### Middleware not running

Make sure:

1. Your `middleware.js` file is in the correct location: base directory, same level as `app` folder.
2. The `matcher` in your config matches your proxy path.
3. You've restarted your dev server after creating the middleware file.

### Using with Clerk or other auth middleware

If you're using Clerk's `authMiddleware` or similar auth solutions, handle PostHog routes in your `beforeAuth` function and add them to `ignoredRoutes`:

```js
export default authMiddleware({
  beforeAuth(req) {
    if (req.nextUrl.pathname.startsWith("/<ph_proxy_path>")) {
      // Handle PostHog proxy using the same logic as the middleware example above
      let url = req.nextUrl.clone()
      const hostname = url.pathname.startsWith("/<ph_proxy_path>/static/")
        ? 'us-assets.i.posthog.com'
        : 'us.i.posthog.com'

      const requestHeaders = new Headers(req.headers)
      requestHeaders.set('host', hostname)

      url.protocol = 'https'
      url.hostname = hostname
      url.port = 443
      url.pathname = url.pathname.replace(/^\/<ph_proxy_path>/, '')

      return NextResponse.rewrite(url, {
        headers: requestHeaders,
      })
    }
  },
  ignoredRoutes: ["/<ph_proxy_path>(.*)"],
})
```

### Cookies being forwarded to PostHog

By default, the middleware forwards all headers including cookies to PostHog. If you don't want to forward authentication cookies, delete them from the request:

```js
const requestHeaders = new Headers(request.headers)
requestHeaders.set('host', hostname)
requestHeaders.delete('cookie') // Remove cookies from forwarded request
```

Alternatively, configure PostHog to use `localStorage` instead of cookies for persistence:

```js
posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY, {
  api_host: "/<ph_proxy_path>",
  persistence: 'localStorage'
})
```

### Still getting 503 or 400 errors

If middleware doesn't resolve the errors, your hosting provider might be incompatible with Next.js proxying. Try:

1. A host-specific proxy like [Netlify redirects](/docs/advanced/proxy/netlify) or [Vercel rewrites](/docs/advanced/proxy/vercel)
2. [PostHog's managed reverse proxy](/docs/advanced/proxy/managed-reverse-proxy)
3. Self-hosting Next.js
