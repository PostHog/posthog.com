---
title: Cloudflare reverse proxy
sidebar: Docs
showTitle: true
platformImageUrl: https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/Cloudflare_Logo_8a4a1284aa.png
---

import ProxyCallout from "../_snippets/proxy-callout.mdx"
import { Steps, Step } from 'components/Docs/Steps'

<ProxyCallout />

This guide shows you how to use Cloudflare as a reverse proxy for PostHog.

There are two options:

1. **Cloudflare Workers:** Works on all plans
2. **DNS and Page Rules:** Simpler setup, but requires a Cloudflare Enterprise plan

## Option 1: Cloudflare Workers

This method works on all Cloudflare plans including the [free plan](https://developers.cloudflare.com/workers/platform/pricing/).

<Steps>

<Step title="Create a worker">

Follow [Cloudflare's Workers guide](https://developers.cloudflare.com/workers/get-started/guide/) to create a new worker.

</Step>

<Step title="Add the proxy code">

Replace the default worker code with:

```javascript
const API_HOST = "us.i.posthog.com" // Change to "eu.i.posthog.com" for EU region
const ASSET_HOST = "us-assets.i.posthog.com" // Change to "eu-assets.i.posthog.com" for EU region

async function handleRequest(request, ctx) {
  const url = new URL(request.url)
  const pathname = url.pathname
  const search = url.search
  const pathWithParams = pathname + search

  if (pathname.startsWith("/static/")) {
    return retrieveStatic(request, pathWithParams, ctx)
  } else {
    return forwardRequest(request, pathWithParams)
  }
}

async function retrieveStatic(request, pathname, ctx) {
  let response = await caches.default.match(request)
  if (!response) {
    response = await fetch(`https://${ASSET_HOST}${pathname}`)
    ctx.waitUntil(caches.default.put(request, response.clone()))
  }
  return response
}

async function forwardRequest(request, pathWithSearch) {
  const ip = request.headers.get("CF-Connecting-IP") || ""
  const originHeaders = new Headers(request.headers)
  originHeaders.delete("cookie")
  originHeaders.set("X-Forwarded-For", ip)

  const originRequest = new Request(`https://${API_HOST}${pathWithSearch}`, {
    method: request.method,
    headers: originHeaders,
    body: request.body,
    redirect: request.redirect
  })

  return await fetch(originRequest)
}

export default {
  async fetch(request, env, ctx) {
    return handleRequest(request, ctx);
  }
};
```

</Step>

<Step title="Add a custom domain">

Using your own domain instead of `*.workers.dev` makes the proxy less likely to be blocked.

Follow [Cloudflare's custom domains guide](https://developers.cloudflare.com/workers/configuration/routing/custom-domains/) to add a subdomain like `e.yourdomain.com`.

Avoid obvious terms like "tracking" or "analytics" in your subdomain name.

</Step>

<Step title="Update your PostHog SDK">

Use your worker's domain as the API host:

```js
posthog.init('<ph_project_api_key>', {
  api_host: 'https://e.yourdomain.com',
  ui_host: 'https://us.posthog.com' // Use https://eu.posthog.com for EU region
})
```

</Step>

</Steps>

## Option 2: DNS and Page Rules (Enterprise only)

This method is simpler but requires a Cloudflare Enterprise plan. It uses DNS records and Page Rules to rewrite headers.

<Steps>

<Step title="Add a DNS record">

Follow [Cloudflare's DNS records guide](https://developers.cloudflare.com/dns/manage-dns-records/how-to/create-dns-records/) to create a CNAME record with:

- **Name:** Your subdomain like `e`
- **Target:** `us-proxy-direct.i.posthog.com` or `eu-proxy-direct.i.posthog.com` for EU
- **Proxy status:** Proxied (orange cloud)

</Step>

<Step title="Create a Page Rule to rewrite headers">

The proxy requires rewriting the Host header. This is only available on Enterprise plans.

Follow [Cloudflare's Page Rules guide](https://support.cloudflare.com/hc/en-us/articles/206652947) to create a rule with:

- **URL pattern:** `e.yourdomain.com/*`
- **Host Header Override:** `us-proxy-direct.i.posthog.com` or `eu-proxy-direct.i.posthog.com`

</Step>

<Step title="Update your PostHog SDK">

Use your CNAME domain as the API host:

```js
posthog.init('<ph_project_api_key>', {
  api_host: 'https://e.yourdomain.com',
  ui_host: 'https://us.posthog.com' // Use https://eu.posthog.com for EU region
})
```

</Step>

</Steps>

## Troubleshooting

### User locations show as the proxy location

By default, all user locations appear as wherever your Cloudflare Worker is hosted. To preserve the original user IP for geolocation, the worker code above uses the `X-Forwarded-For` header with Cloudflare's `CF-Connecting-IP` header.

If you're using an older version of the worker code, update your `forwardRequest` function to include the IP forwarding logic shown in Step 2.

### CORS errors

If you see `Access-Control-Allow-Origin` errors, check the following:

1. Make sure the `ui_host` is set correctly in your PostHog initialization.
2. If using Page Rules, add these settings to your Page Rule:
   - Disable Security
   - SSL: Full
   - Disable Web Application Firewall

### 301 redirects causing CORS failures

This usually happens when your Cloudflare SSL mode is set to "Flexible" instead of "Full". Requests to PostHog must use HTTPS, so Cloudflare's redirect triggers a CORS error.

To fix this, in your Cloudflare dashboard, go to **SSL/TLS** and set the mode to **Full**.

### Unexpected token 'export' error

This error occurs when using the worker code in the wrong context. Cloudflare Workers require ES modules format.

When creating your worker, ensure you're using the **ES module** format, not the Service Worker format. The `export default` syntax requires ES modules.
