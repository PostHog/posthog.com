---
title: Remix reverse proxy
sidebar: Docs
showTitle: true
platformImageUrl: https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/remix_letter_glowing_d2da2f17a7.png
---

import ProxyCallout from "../_snippets/proxy-callout.mdx"
import { Steps, Step } from 'components/Docs/Steps'

<ProxyCallout />

This guide shows you how to use [Remix API routes](https://remix.run/docs/en/main/guides/api-routes) as a reverse proxy for PostHog.

Remix API routes let you create server-side endpoints that proxy requests to PostHog without exposing the PostHog domain to the browser.

## Setup

<Steps>

<Step title="Create an API route file">

Create a file in your `app/routes` folder with this special naming pattern:

```
app/routes/<ph_proxy_path>.$.tsx
```

Replace `<ph_proxy_path>` with your chosen path like `ph`.

The `$` in the filename is a Remix [splat route](https://remix.run/docs/en/main/file-conventions/routes#splat-routes) that matches any sub-paths. This lets the route handle all PostHog requests like `/ph/decide`, `/ph/e/`, and `/ph/static/array.js`.

</Step>

<Step title="Add the proxy code">

Add this code to your route file. It intercepts requests to your proxy path, rewrites them to PostHog's servers, and returns the response:

```tsx
import type { ActionFunction, LoaderFunction } from "@remix-run/node";

const API_HOST = "us.i.posthog.com"; // Change to eu.i.posthog.com for EU
const ASSET_HOST = "us-assets.i.posthog.com"; // Change to eu-assets.i.posthog.com for EU

const posthogProxy = async (request: Request) => {
  const url = new URL(request.url);
  const hostname = url.pathname.startsWith("/<ph_proxy_path>/static/")
    ? ASSET_HOST
    : API_HOST;

  const newUrl = new URL(url);
  newUrl.protocol = "https";
  newUrl.hostname = hostname;
  newUrl.port = "443";
  newUrl.pathname = newUrl.pathname.replace(/^\/<ph_proxy_path>/, "");

  const headers = new Headers(request.headers);
  headers.set("host", hostname);
  headers.delete("accept-encoding");

  const response = await fetch(newUrl, {
    method: request.method,
    headers,
    body: request.body,
    // @ts-ignore
    duplex: 'half',
  });

  const responseHeaders = new Headers(response.headers);
  responseHeaders.delete("content-encoding");
  responseHeaders.delete("content-length");

  const data = await response.arrayBuffer();

  return new Response(data, {
    status: response.status,
    statusText: response.statusText,
    headers: responseHeaders,
  });
};

export const loader: LoaderFunction = async ({ request }) =>
  posthogProxy(request);

export const action: ActionFunction = async ({ request }) =>
  posthogProxy(request);
```

Replace `<ph_proxy_path>` with your chosen path in the code.

</Step>

<Step title="Update your PostHog SDK">

Use your proxy path as the API host:

```js
posthog.init('<ph_project_api_key>', {
  api_host: "/<ph_proxy_path>",
  ui_host: "https://us.posthog.com" // Use https://eu.posthog.com for EU
})
```

Replace `<ph_proxy_path>` with your chosen path.

</Step>

</Steps>

## Troubleshooting

For common issues like region mismatches, `ui_host` configuration, and 405 errors, see [best practices and common issues](/docs/advanced/proxy#best-practices-and-common-issues).

### Route not matching requests

Make sure:

1. Your file is in the `app/routes` folder.
2. The filename includes the `$` character like `ph.$.tsx`.
3. You've restarted your dev server after creating the file.

### Config file appears truncated

If PostHog's config.js file loads partially or appears cut off, make sure you're deleting both the `content-encoding` and `content-length` headers from the response. The original `content-length` reflects the compressed size, which causes browsers to stop reading early.

### Content decoding errors

If you see `ERR_CONTENT_DECODING_FAILED` errors, the proxy is forwarding compressed responses incorrectly. The code above handles this by:

1. Deleting `accept-encoding` from the request so PostHog sends uncompressed data
2. Deleting `content-encoding` and `content-length` from the response
3. Reading the response as an `arrayBuffer` to handle binary content properly

### TypeScript error on duplex property

The `duplex: 'half'` property may show a TypeScript error. This is expected because it's a newer fetch API feature. The `@ts-ignore` comment suppresses this. The code works correctly at runtime.
