---
title: Kubernetes reverse proxy
sidebar: Docs
showTitle: true
showStepsToc: true
platformImageUrl: https://res.cloudinary.com/dmukukwp6/image/upload/q_auto,f_auto/k8_ef15b61337.png
---

import ProxyCallout from "../_snippets/proxy-callout.mdx"
import { Steps, Step } from 'components/Docs/Steps'

<ProxyCallout />

This guide shows you how to use a Kubernetes Ingress Controller to proxy PostHog.

If your team already uses Kubernetes, this method lets you set up a reverse proxy using Kubernetes resources instead of deploying a separate tool.

## Prerequisites

- A Kubernetes cluster with an Ingress Controller installed (like [ingress-nginx](https://kubernetes.github.io/ingress-nginx/))
- `kubectl` configured to access your cluster
- A domain with DNS records pointing to your Ingress Controller's load balancer

## How it works

You'll create two Kubernetes resources:

1. **Ingress**: Routes requests from your domain to PostHog
2. **Service**: Points to PostHog's external domains (`us.i.posthog.com` and `us-assets.i.posthog.com`)

The Ingress Controller handles TLS termination and proxies requests to PostHog.

There are three options depending on your setup:

1. **ingress-nginx:** The most common Ingress Controller, with a complete configuration example
2. **Traefik, HAProxy, or other controllers:** Use the same approach as Option 1 with different annotations
3. **Istio service mesh:** For path-based routing without an Ingress Controller

## Option 1: ingress-nginx

<Steps>

<Step title="Create a configuration file">

Create a file named `posthog-proxy.yaml` with this content:

```yaml
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: posthog-proxy
  annotations:
    kubernetes.io/ingress.class: nginx
    # Tell the Ingress Controller to use PostHog's domain as the upstream host
    nginx.ingress.kubernetes.io/upstream-vhost: us.i.posthog.com
    # Use HTTPS to connect to PostHog
    nginx.ingress.kubernetes.io/backend-protocol: https
    # Configure SSL for the upstream connection
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_ssl_name "us.i.posthog.com";
      proxy_ssl_server_name "on";
spec:
  tls:
  - hosts:
    - e.yourdomain.com # Change to your subdomain
    secretName: your-tls-secret # Change to your TLS certificate secret
  rules:
  - host: e.yourdomain.com # Change to your subdomain
    http:
      paths:
      # Route for static assets
      - pathType: Prefix
        path: /static
        backend:
          service:
            name: posthog-assets-proxy
            port:
              name: https
      # Route for all other PostHog requests
      - pathType: Prefix
        path: /
        backend:
          service:
            name: posthog-proxy
            port:
              name: https

---
# Service pointing to PostHog's main API
apiVersion: v1
kind: Service
metadata:
  name: posthog-proxy
spec:
  type: ExternalName
  externalName: us.i.posthog.com # Change to eu.i.posthog.com for EU region
  ports:
  - name: https
    protocol: TCP
    port: 443

---
# Service pointing to PostHog's asset server
apiVersion: v1
kind: Service
metadata:
  name: posthog-assets-proxy
spec:
  type: ExternalName
  externalName: us-assets.i.posthog.com # Change to eu-assets.i.posthog.com for EU region
  ports:
  - name: https
    protocol: TCP
    port: 443
```

Make sure to update:
- `e.yourdomain.com`: Your subdomain for the proxy
- `your-tls-secret`: Your Kubernetes TLS secret name
- `us.i.posthog.com`: Change to `eu.i.posthog.com` for EU region

</Step>

<Step title="Apply the configuration">

```bash
kubectl apply -f posthog-proxy.yaml
```

</Step>

<Step title="Update your PostHog SDK">

Use your proxy domain as the API host:

```js
posthog.init('<ph_project_api_key>', {
  api_host: 'https://e.yourdomain.com',
  ui_host: 'https://us.posthog.com' // Use https://eu.posthog.com for EU region
})
```

Replace `e.yourdomain.com` with your actual tracking domain.

</Step>

</Steps>

## Option 2: Traefik, HAProxy, or other controllers

If you're using a different Ingress Controller, the general approach is the same but you'll need different annotations:

**Traefik example annotations:**
```yaml
annotations:
  traefik.ingress.kubernetes.io/router.entrypoints: websecure
```

**HAProxy example annotations:**
```yaml
annotations:
  haproxy.org/server-ssl: "true"
```

See your Ingress Controller's documentation for the correct configuration:
- [ingress-nginx annotations](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/)
- [Traefik annotations](https://doc.traefik.io/traefik/providers/kubernetes-ingress/)
- [HAProxy annotations](https://haproxy-ingress.github.io/docs/configuration/keys/)

## Option 3: Istio service mesh

If you're using Istio, you can set up a path-based reverse proxy. This routes requests from a subpath on your domain to PostHog.

For example, `demo.example.com/metrics` â†’ `us-proxy-direct.i.posthog.com`:

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: posthog-proxy-vs
  namespace: demo
spec:
  gateways:
  - yourgateway
  hosts:
  - demo.example.com
  http:
  - name: posthog-proxy
    match:
    - uri:
        prefix: /metrics/
    rewrite:
      uri: /
    route:
    - destination:
        host: us-proxy-direct.i.posthog.com
        port:
          number: 443
      headers:
        request:
          set:
            Host: us-proxy-direct.i.posthog.com
---
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: posthog-proxy
  namespace: posthog
spec:
  hosts:
  - us-proxy-direct.i.posthog.com
  ports:
  - number: 443
    name: https
    protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
  exportTo:
  - '*'
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: posthog-proxy-tls
  namespace: posthog
spec:
  host: us-proxy-direct.i.posthog.com
  trafficPolicy:
    tls:
      mode: SIMPLE
      sni: us-proxy-direct.i.posthog.com
```

Make sure to update:
- `demo.example.com`: Your domain
- `/metrics/`: Your desired subpath
- `yourgateway`: Your Istio gateway name
- `us-proxy-direct.i.posthog.com`: Change to `eu-proxy-direct.i.posthog.com` for EU region

## Troubleshooting

### Check your Ingress status

Verify your Ingress is configured correctly:

```bash
kubectl get ingress posthog-proxy
kubectl describe ingress posthog-proxy
```

### Check your Services

Verify your Services are pointing to the correct external domains:

```bash
kubectl get service posthog-proxy posthog-assets-proxy
kubectl describe service posthog-proxy
```

### Check Ingress Controller logs

If requests aren't working, check your Ingress Controller's logs:

```bash
# For ingress-nginx
kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
```
