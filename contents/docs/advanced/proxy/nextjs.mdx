---
title: Use Next.js rewrites as a reverse proxy
sidebar: Docs
showTitle: true
---

import ProxyCallout from "../_snippets/proxy-callout.mdx"
import { Steps, Step } from 'components/Docs/Steps'

<ProxyCallout />

This guide shows you how to use [Next.js rewrites](https://nextjs.org/docs/app/api-reference/next-config-js/rewrites) as a reverse proxy for PostHog.

Next.js rewrites let you proxy requests from your domain to PostHog without changing the URL in the browser.

<iframe
  src="https://www.youtube-nocookie.com/embed/MD-jI2moPV0"
  className="rounded shadow-xl"
/>

<CalloutBox icon="IconWarning" title="Note on hosting compatibility" type="fyi">

This method works best when self-hosting Next.js or using Vercel. Some hosting services (like Heroku or Netlify) modify headers when using rewrites, which can cause `503` or `400` errors.

If you're experiencing issues, try [Next.js middleware](/docs/advanced/proxy/nextjs-middleware) or a host-specific proxy like [Netlify](/docs/advanced/proxy/netlify) instead.

</CalloutBox>

## Setup

<Steps>

<Step title="Add rewrites to next.config.js">

Add a `rewrites()` function and the `skipTrailingSlashRedirect` option to your `next.config.js` file:

```js
// next.config.js
const nextConfig = {
  async rewrites() {
    return [
      {
        source: "/<ph_proxy_path>/static/:path*",
        destination: "https://us-assets.i.posthog.com/static/:path*",
      },
      {
        source: "/<ph_proxy_path>/:path*",
        destination: "https://us.i.posthog.com/:path*",
      },
    ];
  },
  // This is required to support PostHog trailing slash API requests
  skipTrailingSlashRedirect: true, 
}

module.exports = nextConfig
```

Replace `<ph_proxy_path>` with your chosen path (like `ph`). Replace `us` with `eu` for EU region.

See [Next.js rewrites documentation](https://nextjs.org/docs/app/api-reference/next-config-js/rewrites) for more details.

</Step>

<Step title="Update your PostHog SDK">

Use your rewrite path as the API host:

```js
posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY, {
  api_host: "/<ph_proxy_path>",
  ui_host: "https://us.posthog.com" // Use https://eu.posthog.com for EU region
})
```

Replace `<ph_proxy_path>` with your chosen path.

</Step>

<Step title="Deploy your changes">

Deploy your Next.js app. The rewrites will be active once deployed.

</Step>

</Steps>

## Troubleshooting

For common issues like region mismatches, `ui_host` configuration, and 405 errors, see [best practices and common issues](/docs/advanced/proxy#best-practices-and-common-issues).

### 503 or 400 errors

Some hosting services modify headers when using rewrites, which causes errors. This commonly happens with:
- Heroku
- Netlify (modifies `Content-Encoding` header)

Solutions:
1. Use [Next.js middleware](/docs/advanced/proxy/nextjs-middleware) instead
2. Use a host-specific proxy (like [Netlify redirects](/docs/advanced/proxy/netlify))
3. Self-host Next.js or use Vercel

### Rewrites not working

Make sure:
1. Your `next.config.js` is in your project root.
2. You've restarted your dev server after changing the config.
3. The rewrites are listed in the correct order (static assets first, then catch-all).

### Trailing slash conflicts with SEO

The `skipTrailingSlashRedirect: true` setting is required for PostHog API requests to work correctly, but it can cause SEO issues if your site becomes accessible at both `/page` and `/page/`.

Solutions:
1. **Use middleware for redirects**: Handle trailing slash redirects in your [Next.js middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware) for non-PostHog routes while keeping `skipTrailingSlashRedirect: true`.
2. **Set canonical URLs**: Use the `<link rel="canonical">` tag to specify the preferred URL version for search engines.
3. **Configure in robots.txt or sitemap**: Ensure your sitemap only includes the canonical version of each URL.

### Request body not forwarded (401 errors)

Some hosting platforms strip the request body during rewrites, causing authentication errors. If you see `No project API key provided` errors and have verified your region is correct, try [Next.js middleware](/docs/advanced/proxy/nextjs-middleware) instead.
