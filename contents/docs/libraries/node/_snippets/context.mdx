The Node SDK uses nested contexts for managing state that's shared across events. Contexts are useful for adding properties to multiple events (including exceptions) during a single user's interaction with your product.

<CalloutBox icon="IconInfo" title="Context propagation">

Functions passed to `withContext` must be `async`. Context propagation is **not guaranteed** for synchronous (non-async) functions due to how Node.js handles asynchronous context tracking.

</CalloutBox>

You can enter a context using `withContext`:

```node
posthog.withContext(
  {
    distinctId: 'user-123',
    properties: { transactionId: 'abc123' }
  },
  async () => {
    // This event is captured with the distinct ID and properties set above
    posthog.capture({ event: 'order_processed' })
  }
)
```

Contexts are persisted across function calls. If you enter one and then call a function and capture an event in the called function, it uses the context properties set in the parent context:

```node
async function someFunction() {
  // When called from `outerFunction`, this event is captured
  // with transactionId='abc123'
  posthog.capture({ event: 'order_processed' })
}

function outerFunction() {
  posthog.withContext(
    { properties: { transactionId: 'abc123' } },
    async () => {
      someFunction()
    }
  )
}
```

By default, each context is "fresh" and doesn't inherit from parent contexts. To enable nesting (where child contexts inherit and can override parent properties), pass `{ fresh: false }`:

```node
posthog.withContext(
  {
    properties: {
      someKey: 'value-1',
      someOtherKey: 'another-value'
    }
  },
  async () => {
    posthog.withContext(
      { properties: { someKey: 'value-2' } },
      async () => {
        // Captured with someKey='value-2', someOtherKey='another-value'
        posthog.capture({ event: 'order_processed' })
      },
      { fresh: false }
    )

    // Captured with someKey='value-1', someOtherKey='another-value'
    posthog.capture({ event: 'order_completed' })
  }
)
```

> **Note:** Properties passed directly to `capture` calls override context state in the final event.

### Supported parameters

Contexts can be associated with a distinct ID:

```node
posthog.withContext(
  { distinctId: 'user-123' },
  () => {
    // Associated with "user-123"
    posthog.capture({ event: 'order_processed' })

    // Overrides to "another-user"
    posthog.capture({
      distinctId: 'another-user',
      event: 'order_processed'
    })
  }
)
```

With a session:

```node
posthog.withContext(
  { sessionId: 'some-session' },
  () => {
    // Associated with session "some-session"
    posthog.capture({ event: 'image_uploaded' })

    // Overrides to "next-session"
    posthog.capture({
      event: 'image_uploaded',
      properties: { $sessionId: 'next-session' }
    })
  }
)
```

Or with your custom properties:

```node
posthog.withContext(
  { flightNumber: 'TAC313' },
  () => {
    // Associated with flightNumber TAC313
    posthog.capture({ event: 'flight_cancelled' })

    // Overrides to PL7714
    posthog.capture({
      event: 'flight_cancelled',
      properties: { flightNumber: 'PL7714' }
    })
  }
)
```
